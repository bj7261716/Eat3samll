# 💰 Google Maps API 費用控制完整指南

## 📊 Google Maps API 收費機制詳解

### 免費額度

Google Maps Platform 提供每月 **$200 美元** 的免費額度。

> [!IMPORTANT]
> **$200 美元免費額度可以做什麼?**
> 
> 以本專案使用的 API 為例:
> - **Maps JavaScript API**: 約 28,000 次地圖載入
> - **Places API (Nearby Search)**: 約 6,000 次搜尋
> - **Places API (Place Details)**: 約 6,000 次詳細資訊查詢
> 
> 對於個人專案或小型網站,通常**完全免費**!

### 計費方式

Google Maps Platform 採用 **按使用量計費** (Pay-as-you-go):

1. **每月前 $200 美元免費**
2. **超過免費額度才收費**
3. **沒有最低消費或訂閱費**

---

## 💵 詳細收費標準 (2024 年價格)

### 1. Maps JavaScript API

**功能:** 載入互動式地圖

| 使用量 | 每 1,000 次價格 | 免費額度可用次數 |
|--------|----------------|-----------------|
| 動態地圖載入 | $7.00 | ~28,571 次 |
| 動態街景載入 | $7.00 | ~28,571 次 |
| 靜態地圖載入 | $2.00 | ~100,000 次 |

**本專案使用:** 動態地圖載入

**計算範例:**
```
每次使用者開啟網站 = 1 次地圖載入
100 位使用者每天訪問 1 次 = 100 次/天 = 3,000 次/月
費用 = (3,000 / 1,000) × $7 = $21
實際費用 = $21 - $200 免費額度 = $0 (免費!)
```

### 2. Places API (New)

**功能:** 搜尋附近餐廳、取得餐廳詳細資訊

| API 類型 | 每 1,000 次價格 | 免費額度可用次數 |
|---------|----------------|-----------------|
| Nearby Search | $32.00 | ~6,250 次 |
| Text Search | $32.00 | ~6,250 次 |
| Place Details (Basic) | $17.00 | ~11,765 次 |
| Place Details (Contact) | $3.00 | ~66,667 次 |
| Place Details (Atmosphere) | $5.00 | ~40,000 次 |

**本專案使用:**
- Nearby Search (搜尋附近餐廳)
- Place Details (取得餐廳資訊)

**計算範例:**
```
每次搜尋 = 1 次 Nearby Search + 5 次 Place Details
100 位使用者每天搜尋 2 次 = 200 次搜尋/天 = 6,000 次搜尋/月

Nearby Search 費用 = (6,000 / 1,000) × $32 = $192
Place Details 費用 = (30,000 / 1,000) × $17 = $510
總費用 = $702
實際費用 = $702 - $200 免費額度 = $502/月

⚠️ 這個使用量會產生費用!
```

### 3. Geolocation API

**功能:** 取得使用者位置

| 使用量 | 每 1,000 次價格 | 免費額度可用次數 |
|--------|----------------|-----------------|
| 地理位置請求 | $5.00 | ~40,000 次 |

**本專案使用:** 地理位置請求 (但通常使用瀏覽器內建的 Geolocation API,不計費)

---

## 🎯 如何控制在免費額度內?

### 策略 1: 設定每日配額上限 ⭐ 最重要!

限制每日 API 請求次數,防止意外超額。

#### 步驟:

1. **前往 Google Cloud Console**
   - 開啟: https://console.cloud.google.com/

2. **選擇專案**
   - 在頂部選擇你的專案

3. **進入 API 配額設定**
   - 左側選單: `API 和服務` → `已啟用的 API 和服務`
   - 點擊 `Maps JavaScript API`
   - 點擊 `配額和系統限制` 標籤

4. **設定每日請求上限**
   
   找到 "Map loads per day" (每日地圖載入次數):
   - 點擊編輯圖示 ✏️
   - 設定上限,例如: **1,000 次/天**
   - 點擊 `儲存`

5. **重複設定其他 API**
   
   對 Places API 也進行相同設定:
   - 前往 `Places API (New)`
   - 設定 "Requests per day" 上限,例如: **200 次/天**

#### 建議配額設定:

```
Maps JavaScript API:
  每日地圖載入: 1,000 次/天
  
Places API (New):
  每日搜尋請求: 200 次/天
  
Geolocation API:
  每日請求: 500 次/天
```

**計算:**
```
每月 Maps 載入 = 1,000 × 30 = 30,000 次
費用 = (30,000 / 1,000) × $7 = $210
實際費用 = $210 - $200 免費額度 = $10/月

每月 Places 搜尋 = 200 × 30 = 6,000 次
費用 = (6,000 / 1,000) × $32 = $192
實際費用 = $192 (已在 $200 免費額度內)

總費用 ≈ $10/月 (可接受)
```

### 策略 2: 設定帳單警示 ⭐ 必做!

當費用達到特定金額時,自動發送電子郵件警告。

#### 步驟:

1. **前往帳單設定**
   - Google Cloud Console → 左側選單 ☰
   - 選擇 `帳單`
   - 選擇你的帳單帳戶

2. **建立預算和警示**
   - 點擊左側的 `預算和警示`
   - 點擊 `建立預算`

3. **設定預算範圍**
   - 專案: 選擇你的專案
   - 服務: 選擇 "所有服務" 或特定 API
   - 點擊 `下一步`

4. **設定預算金額**
   - 預算類型: 選擇 `指定金額`
   - 目標金額: 輸入 `$10` (或你的預算)
   - 點擊 `下一步`

5. **設定警示門檻**
   
   建議設定多個警示:
   ```
   ✅ 50% ($5) - 提醒注意
   ✅ 75% ($7.5) - 需要檢查
   ✅ 90% ($9) - 立即處理
   ✅ 100% ($10) - 超過預算!
   ```

6. **設定通知方式**
   - 勾選 `電子郵件警示給帳單管理員和使用者`
   - (可選) 設定 Pub/Sub 主題以接收程式化通知
   - 點擊 `完成`

### 策略 3: 優化程式碼,減少 API 呼叫

#### 技巧 1: 快取搜尋結果

```javascript
// 在 js/storage.js 中已實作
// 將搜尋結果儲存在 localStorage
// 相同條件的搜尋可以直接使用快取,不重新呼叫 API
```

#### 技巧 2: 延遲載入地圖

```javascript
// 只在使用者切換到地圖視圖時才載入地圖
// 避免每次開啟網站都載入地圖
```

#### 技巧 3: 限制搜尋頻率

```javascript
// 使用 debounce 技術
// 避免使用者快速連續搜尋造成多次 API 呼叫
```

#### 技巧 4: 減少 Place Details 請求

```javascript
// 只在使用者點擊餐廳時才取得詳細資訊
// 不要一次取得所有餐廳的詳細資訊
```

### 策略 4: 設定帳單上限 (進階)

> [!CAUTION]
> **設定帳單上限會在達到上限時停止所有 API 服務!**
> 
> 這會導致你的網站功能失效,請謹慎使用。

如果你想要**絕對確保**不會產生費用:

1. 前往 `帳單` → `帳戶管理`
2. 找到 "付款設定"
3. 設定每月支出上限 (例如: $0 或 $5)
4. 達到上限後,所有 API 請求都會被拒絕

**建議:** 使用帳單警示而非上限,這樣可以保持網站運作。

---

## 📈 監控 API 使用量

### 方法 1: Google Cloud Console 儀表板

1. **前往 API 儀表板**
   - Google Cloud Console → `API 和服務` → `資訊主頁`

2. **查看使用量圖表**
   - 可以看到每個 API 的請求次數
   - 可以選擇時間範圍 (今天、本週、本月)

3. **查看詳細報表**
   - 點擊特定 API 可以看到更詳細的使用統計

### 方法 2: 帳單報表

1. **前往帳單頁面**
   - Google Cloud Console → `帳單` → `報表`

2. **查看費用趨勢**
   - 可以看到每日、每週、每月的費用
   - 可以按服務分類查看

3. **匯出報表**
   - 可以匯出 CSV 或 PDF 格式的報表

### 方法 3: 設定每日檢查提醒

建議每週檢查一次 API 使用量:

```
✅ 每週一檢查上週使用量
✅ 每月初檢查上月總費用
✅ 收到警示郵件時立即檢查
```

---

## 🚨 超額處理流程

### 如果收到警示郵件:

1. **立即檢查使用量**
   - 前往 Google Cloud Console 查看詳細使用統計
   - 確認是正常使用還是異常流量

2. **分析原因**
   
   **正常情況:**
   - 網站流量增加
   - 使用者搜尋次數增加
   
   **異常情況:**
   - API 金鑰被盜用
   - 程式碼有 bug 造成重複請求
   - 遭受攻擊

3. **採取行動**
   
   **如果是正常增長:**
   - 考慮增加預算
   - 優化程式碼減少 API 呼叫
   - 升級到付費方案
   
   **如果是異常情況:**
   - 立即停用 API 金鑰
   - 建立新的 API 金鑰並設定嚴格限制
   - 檢查並修復程式碼問題
   - 聯絡 Google 支援申請費用減免

### 緊急停止 API 使用:

1. 前往 `API 和服務` → `憑證`
2. 找到你的 API 金鑰
3. 點擊刪除或停用
4. API 請求會立即停止

---

## 💡 成本優化建議

### 1. 使用瀏覽器內建的 Geolocation API

本專案已經使用瀏覽器的 `navigator.geolocation`,不需要呼叫 Google Geolocation API,可以節省費用。

### 2. 實作搜尋結果快取

```javascript
// 已在 js/storage.js 實作
// 相同條件的搜尋會使用快取結果
// 可以減少 50% 以上的 API 請求
```

### 3. 限制搜尋範圍

```javascript
// 在 js/config.js 中設定較小的搜尋半徑
// 減少搜尋半徑可以減少返回的結果數量
searchRadius: {
    '1km': 1000,  // 優先使用較小範圍
    '3km': 3000,
    '5km': 5000
}
```

### 4. 使用靜態地圖 (如果不需要互動)

如果某些頁面不需要互動式地圖,可以使用 Static Maps API,費用更低。

### 5. 延遲載入非必要功能

```javascript
// 只在使用者需要時才載入地圖
// 不要在頁面載入時就初始化所有功能
```

---

## 📋 費用控制檢查清單

部署前請確認:

```
✅ 已設定每日 API 配額上限
✅ 已設定帳單警示 (50%, 75%, 90%, 100%)
✅ 已設定每月預算上限
✅ 已了解各 API 的收費標準
✅ 已實作搜尋結果快取
✅ 已設定 API 金鑰限制 (參考 API_SECURITY.md)
✅ 已知道如何查看使用量報表
✅ 已知道如何處理超額情況
```

---

## 🎓 實際使用範例

### 小型個人網站 (每月 100 位訪客)

**假設:**
- 每位訪客平均訪問 2 次/月
- 每次訪問執行 1 次搜尋
- 每次搜尋返回 5 家餐廳

**計算:**
```
地圖載入 = 100 × 2 = 200 次/月
費用 = (200 / 1,000) × $7 = $1.4

搜尋請求 = 100 × 2 = 200 次/月
費用 = (200 / 1,000) × $32 = $6.4

Place Details = 200 × 5 = 1,000 次/月
費用 = (1,000 / 1,000) × $17 = $17

總費用 = $1.4 + $6.4 + $17 = $24.8
實際費用 = $24.8 - $200 免費額度 = $0 (完全免費!)
```

### 中型網站 (每月 1,000 位訪客)

**計算:**
```
地圖載入 = 1,000 × 2 = 2,000 次/月
費用 = (2,000 / 1,000) × $7 = $14

搜尋請求 = 1,000 × 2 = 2,000 次/月
費用 = (2,000 / 1,000) × $32 = $64

Place Details = 2,000 × 5 = 10,000 次/月
費用 = (10,000 / 1,000) × $17 = $170

總費用 = $14 + $64 + $170 = $248
實際費用 = $248 - $200 免費額度 = $48/月
```

**建議:** 實作快取機制,可以減少到 $20/月 以下

---

## 🔗 相關資源

- **Google Maps Platform 定價:**
  https://mapsplatform.google.com/pricing/

- **定價計算器:**
  https://mapsplatform.google.com/pricing/calculator/

- **帳單管理:**
  https://cloud.google.com/billing/docs

- **成本優化指南:**
  https://cloud.google.com/maps-platform/pricing/cost-optimization

---

## 💬 常見問題

### Q1: 免費額度會過期嗎?

A: 不會。每個月都會重新獲得 $200 美元的免費額度,未使用的額度不會累積到下個月。

### Q2: 需要綁定信用卡嗎?

A: 是的。即使使用免費額度,Google 也要求設定帳單帳戶並綁定信用卡。但只要在免費額度內,不會扣款。

### Q3: 如果超過免費額度會怎樣?

A: 會開始計費,費用會從你的信用卡扣款。建議設定帳單警示以避免意外費用。

### Q4: 可以設定絕對不扣款嗎?

A: 可以設定帳單上限為 $0,但達到上限後 API 會停止服務,網站功能會失效。

### Q5: 學生或非營利組織有優惠嗎?

A: Google 有提供教育和非營利組織方案,請參考:
https://cloud.google.com/edu

---

> [!TIP]
> **最佳實踐總結**
> 
> 1. ✅ 設定每日配額上限 (最重要!)
> 2. ✅ 設定多層級帳單警示
> 3. ✅ 每週檢查使用量
> 4. ✅ 實作快取機制
> 5. ✅ 優化程式碼減少不必要的 API 呼叫
> 
> 遵循這些建議,個人專案通常可以**完全免費**使用!

**控制成本,安心使用 Google Maps API!** 💰✨
